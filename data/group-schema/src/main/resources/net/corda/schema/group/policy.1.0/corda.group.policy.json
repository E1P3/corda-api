{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://corda.r3.com/net/corda/schema/group/policy/1.0/corda.group.policy.json",
  "title": "Corda Group Policy Schema",
  "description": "Schema for the group policy file included in distributed CPIs.",
  "type": "object",
  "required": [
    "fileFormatVersion",
    "groupId",
    "registrationProtocol"
  ],
  "properties": {
    "fileFormatVersion": {
      "description": "The version of the schema which this file format adheres to.",
      "type": "number"
    },
    "groupId": {
      "description": "The group ID that this file relates to, or constant 'CREATE_ID' if a new ID must be generated. A new ID should be generated only for an MGM.",
      "type": "string"
    },
    "registrationProtocol": {
      "description": "The fully qualified class name of the registration protocol implementation class.",
      "type": "string"
    },
    "synchronisationProtocol": {
      "description": "The fully qualified class name of the synchronisation protocol implementation class.",
      "type": "string"
    },
    "p2pParameters": {
      "$ref": "#/$defs/p2pParameters"
    },
    "mgmInfo": {
      "$ref": "#/$defs/mgmInfo"
    },
    "cipherSuite": {
      "$ref": "#/$defs/cipherSuite"
    }
  },
  "allOf": [
    {
      "if": {
        "not": {
          "properties": {
            "groupId": {
              "$ref": "#/$defs/mgmGroupId"
            }
          }
        }
      },
      "then": {
        "if": {
          "properties": {
            "protocolParameters": {
              "required": [
                "staticNetwork"
              ]
            }
          }
        },
        "then": {
          "$comment": "Properties for a group policy for a static network",
          "required": [
            "synchronisationProtocol",
            "p2pParameters",
            "cipherSuite",
            "protocolParameters"
          ],
          "properties": {
            "fileFormatVersion": true,
            "groupId": true,
            "registrationProtocol": true,
            "synchronisationProtocol": true,
            "p2pParameters": true,
            "mgmInfo": false,
            "cipherSuite": true,
            "protocolParameters": {
              "$ref": "#/$defs/protocolParameters"
            }
          },
          "additionalProperties": false
        },
        "else": {
          "$comment": "Properties for a group policy generated for a member by an MGM",
          "required": [
            "synchronisationProtocol",
            "p2pParameters",
            "mgmInfo",
            "cipherSuite",
            "protocolParameters"
          ],
          "properties": {
            "fileFormatVersion": true,
            "groupId": true,
            "registrationProtocol": true,
            "synchronisationProtocol": true,
            "p2pParameters": true,
            "mgmInfo": true,
            "cipherSuite": true,
            "protocolParameters": {
              "$ref": "#/$defs/protocolParameters"
            }
          },
          "additionalProperties": false
        }
      },
      "else": {
        "$comment": "Properties for an MGM group policy",
        "properties": {
          "fileFormatVersion": true,
          "groupId": true,
          "registrationProtocol": true,
          "synchronisationProtocol": true,
          "p2pParameters": false,
          "mgmInfo": false,
          "cipherSuite": false,
          "protocolParameters": {
            "$ref": "#/$defs/mgmProtocolParameters"
          }
        },
        "additionalProperties": false
      }
    }
  ],
  "$defs": {
    "mgmGroupId": {
      "const": "CREATE_ID"
    },
    "mgmInfo": {
      "description": "The member information of the group MGM which members should use to join a group.",
      "type": "object",
      "required": [
        "name",
        "sessionKey",
        "ecdhKey",
        "endpoints",
        "platformVersion",
        "softwareVersion",
        "serial"
      ],
      "properties": {
        "name": {
          "description": "The X500Name of the group MGM.",
          "type": "string"
        },
        "sessionKey": {
          "description": "The public key belonging to the MGM to be used for session initiation.",
          "type": "string"
        },
        "certificate": {
          "description": "The full certificate chain for the session key certificate.",
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "ecdhKey": {
          "description": "Static DH key for ECIES encryption used during member registration.",
          "type": "string"
        },
        "endpoints": {
          "description": "The endpoints available for use for P2P communication with the MGM.",
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": [
              "url",
              "protocolVersion"
            ],
            "properties": {
              "url": {
                "description": "The URL for the endpoint.",
                "type": "string"
              },
              "protocolVersion": {
                "description": "Protocol version supported by this endpoint.",
                "type": "integer"
              }
            },
            "additionalProperties": false
          }
        },
        "platformVersion": {
          "description": "The version of the Corda platform that the MGM is running on.",
          "type": "integer"
        },
        "softwareVersion": {
          "description": "The software version of Corda that the MGM is running on.",
          "type": "string"
        },
        "serial": {
          "description": "An arbitrary number incremented each time the MemberInfo is changed.",
          "type": "integer"
        }
      }
    },
    "p2pParameters": {
      "description": "All parameters required to configure the P2P communication before registration and synchronisation.",
      "type": "object",
      "properties": {
        "sessionTrustStore": {
          "description": "The trust roots for session initiation certificate verification.",
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "sessionPki": {
          "description": "The PKI type to use for session handling.",
          "enum": [
            "Standard",
            "Corda4",
            "NoPKI"
          ]
        },
        "tlsTrustStore": {
          "description": "The trust roots for TLS certificate verification.",
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "tlsPki": {
          "description": "The PKI type to use for TLS handling.",
          "enum": [
            "Standard",
            "Corda4"
          ]
        },
        "protocolMode": {
          "description": "The type of end to end session to use.",
          "enum": [
            "Authentication",
            "Authentication_Encryption"
          ]
        }
      },
      "additionalProperties": false,
      "required": [
        "sessionPki",
        "tlsTrustStore",
        "tlsPki",
        "protocolMode"
      ],
      "anyOf": [
        {
          "if": {
            "not": {
              "properties": {
                "sessionPki": {
                  "const": "NoPKI"
                }
              }
            }
          },
          "then": {
            "required": [
              "sessionTrustStore"
            ]
          }
        }
      ]
    },
    "protocolParameters": {
      "description": "All parameters required to perform the registration or synchronisation protocols.",
      "type": "object",
      "properties": {
        "sessionKeyPolicy": {
          "description": "Whether to use combined or distinct keys for ledger signing and end-to-end session authentication",
          "enum": [
            "Combined",
            "Distinct"
          ]
        },
        "staticNetwork": {
          "description": "The configuration for set up of a static network.",
          "type": "object",
          "required": [
            "mgm",
            "members"
          ],
          "properties": {
            "mgm": {
              "description": "Configuration of a faked MGM for the static network as a string-string map.",
              "type": "object"
            },
            "members": {
              "description": "The member templates for the members to be added to the static network member list.",
              "type": "array",
              "items": {
                "description": "A member template as a map of values for a member to be added to the static network member list.",
                "type": "object"
              }
            }
          },
          "additionalProperties": false
        }
      },
      "required": [
        "sessionKeyPolicy"
      ]
    },
    "mgmProtocolParameters": {
      "description": "All parameters required for an MGM to perform the registration or synchronisation protocols.",
      "type": "object"
    },
    "cipherSuite": {
      "description": "Parameters of the cipher suite in use as a map of string to string.",
      "type": "object",
      "additionalProperties": {
        "type": "string"
      }
    }
  }
}